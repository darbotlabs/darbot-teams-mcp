# Copilot Instructions for Darbot Teams MCP

## Repository Overview

This is a **Microsoft Teams Management Tool** built as a Model Context Protocol (MCP) server using .NET 9. The project enables AI agents and tools to interact with Microsoft Teams through a standardized protocol interface.

### Key Architecture Components
- **MCP Server**: HTTP and stdio modes for client integration
- **Teams Integration**: Microsoft Graph API for Teams operations  
- **Authentication**: Multiple credential detection methods (Azure CLI, VS Code, Windows Credential Manager)
- **Tool Registry**: 47+ commands across 9 functional categories
- **Permission System**: Role-based access control (Owner/Member/Guest)

## Technology Stack
- **.NET 9** with C# 12 and F# 8
- **ASP.NET Core** for HTTP server
- **Microsoft Graph SDK** for Teams API
- **Serilog** for structured logging
- **FluentValidation** for input validation
- **Node.js/NPM** for distribution packaging

## Project Structure
```
src/
├── DarbotTeamsMcp.Core/          # Core interfaces and models
├── DarbotTeamsMcp.Commands/      # Teams command implementations
├── DarbotTeamsMcp.Service/       # Business logic and services
└── DarbotTeamsMcp.Server/        # MCP server and API controllers

tests/
├── DarbotTeamsMcp.Tests.Unit/    # Unit tests
└── DarbotTeamsMcp.Tests.Integration/ # Integration tests

scripts/                          # NPM build and setup scripts
configs/                          # Configuration templates
```

## Development Guidelines

### Code Style & Standards
- **C# Code**: Follow .NET coding conventions and use nullable reference types
- **F# Code**: Use functional programming patterns, prefer immutable data structures
- **Documentation**: Add XML comments for public APIs (many are currently missing - this is a known issue)
- **Logging**: Use structured logging with Serilog, include correlation IDs
- **Error Handling**: Use Result patterns for operations that can fail, avoid throwing exceptions for business logic

### Language-Specific Guidance

#### C# Code
- Use modern C# features (pattern matching, switch expressions, records)
- Prefer `async/await` for I/O operations
- Use dependency injection for service resolution
- Follow naming conventions: PascalCase for public members, camelCase for local variables

#### F# Code
- Use functional composition and pipelines (`|>`)
- Prefer pattern matching over if/else chains
- Use computation expressions for async operations
- Keep functions pure when possible

### MCP Protocol Requirements
- All tools must implement `ITeamsTool` interface
- Tools must provide JSON schema for input validation
- Commands should be idempotent where possible
- Use proper MCP error codes and messages
- Support both HTTP (port 3001) and stdio modes

### Authentication & Security
- Never commit secrets or credentials
- Use the existing credential detection system
- Respect Teams permission levels in command implementations
- Log security-relevant operations for audit

## Build & Test Commands

### Building
```bash
# Full build
dotnet build

# Build specific project
dotnet build src/DarbotTeamsMcp.Server

# NPM package build
npm run build
```

### Testing
```bash
# Run all tests
dotnet test

# Run with coverage
dotnet test --collect:"XPlat Code Coverage"

# Test MCP server functionality
./test-mcp-server.sh

# NPM test
npm test
```

### Development Workflow
```bash
# Start development server (HTTP mode)
cd src/DarbotTeamsMcp.Server
dotnet run

# Start in stdio mode for MCP clients
dotnet run -- --stdio

# NPM development
npm run vscode-setup  # Configure VS Code integration
```

## Common Tasks

### Adding New Teams Commands
1. Create command class implementing `ITeamsTool` in `DarbotTeamsMcp.Commands`
2. Add proper JSON schema and validation
3. Register in the tool registry
4. Add unit tests for the command
5. Update documentation if needed

### API Integration
- Use the existing `ITeamsGraphClient` interface
- Handle Graph API rate limits appropriately
- Mock the client for unit tests using `MockTeamsGraphClient`
- Add proper error handling for API failures

### Configuration
- Environment variables start with `TEAMS_`
- Use the existing `.env` setup or VS Code settings
- Support both development and production configurations
- Auto-detect credentials where possible

## Testing Strategy
- **Unit Tests**: Focus on command logic and business rules
- **Integration Tests**: Test against mock Graph API
- **MCP Tests**: Validate protocol compliance and tool registration
- Use the existing test projects and follow their patterns

## Performance Considerations
- Use async/await for all I/O operations
- Implement caching for frequently accessed data
- Consider rate limiting for Graph API calls
- Log performance metrics for monitoring

## Deployment & Distribution
- NPM package provides easy installation: `npm install -g darbot-teams-mcp`
- Supports Windows, macOS, and Linux
- Auto-configures VS Code and Claude Desktop
- Local-first deployment (no cloud dependencies)

## Common Issues to Avoid
- Don't block async operations
- Handle Graph API throttling gracefully
- Always validate user permissions before executing commands
- Don't log sensitive information (tokens, personal data)
- Ensure MCP responses are properly formatted JSON-RPC 2.0

## Contribution Workflow
1. Build and test changes locally
2. Follow existing code patterns and architecture
3. Add appropriate tests for new functionality
4. Update documentation if adding public APIs
5. Ensure builds pass with minimal warnings